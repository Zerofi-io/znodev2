#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

PID_FILE="$SCRIPT_DIR/znode.pid"
LOG_FILE="$SCRIPT_DIR/znode.log"
ORACLE_PID_FILE="$SCRIPT_DIR/heartbeat-oracle.pid"
ORACLE_LOG_FILE="$SCRIPT_DIR/heartbeat-oracle.log"
MAX_LOG_SIZE="${MAX_LOG_SIZE_MB:-100}"  # Default 100MB
MAX_LOG_FILES="${MAX_LOG_FILES:-5}"     # Keep 5 rotated logs

# Log rotation function
rotate_logs() {
  if [ ! -f "$LOG_FILE" ]; then
    return
  fi
  
  local size_mb=$(du -m "$LOG_FILE" 2>/dev/null | cut -f1)
  if [ "$size_mb" -ge "$MAX_LOG_SIZE" ]; then
    echo "[start] Rotating log file (${size_mb}MB >= ${MAX_LOG_SIZE}MB)"
    
    # Rotate existing logs
    for i in $(seq $((MAX_LOG_FILES - 1)) -1 1); do
      if [ -f "${LOG_FILE}.$i" ]; then
        mv "${LOG_FILE}.$i" "${LOG_FILE}.$((i + 1))"
      fi
    done
    
    # Move current log to .1
    mv "$LOG_FILE" "${LOG_FILE}.1"
    
    # Remove oldest log if exceeds max
    if [ -f "${LOG_FILE}.$((MAX_LOG_FILES + 1))" ]; then
      rm -f "${LOG_FILE}.$((MAX_LOG_FILES + 1))"
    fi
  fi
}

if [ -f "$PID_FILE" ]; then
  PID="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [ -n "${PID}" ] && kill -0 "$PID" 2>/dev/null; then
    echo "[start] znode is already running with PID $PID"
    exit 0
  else
    echo "[start] Removing stale pidfile"
    rm -f "$PID_FILE"
  fi
fi

# Rotate logs before starting
rotate_logs

echo "[start] Starting Monero wallet RPC..."
./start-monero-rpc.sh || { echo "[start] Failed to start Monero RPC"; exit 1; }

echo "[start] Starting znode..."
nohup node node.js >> "$LOG_FILE" 2>&1 &
PID=$!
echo "$PID" > "$PID_FILE"

echo "[start] znode started with PID $PID (logs: $LOG_FILE)"

echo "[start] Starting P2P heartbeat oracle..."
nohup node p2p-heartbeat-oracle.js >> "$ORACLE_LOG_FILE" 2>&1 &
ORACLE_PID=$!
echo "$ORACLE_PID" > "$ORACLE_PID_FILE"
echo "[start] heartbeat oracle started with PID $ORACLE_PID (logs: $ORACLE_LOG_FILE)"
